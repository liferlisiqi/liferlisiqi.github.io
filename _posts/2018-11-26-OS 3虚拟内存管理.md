---
layout:     post
title:      OS 3虚拟内存管理        
date:       2018-11-26      
author:     lsq    
header-img: img/post-bg-coffee.jpeg
catalog: true
tags:
    - OS
---


# 1 背景
在物理内存分配方法中，要求执行指令必须在物理内存中，满足这一要求的方法是将整个进程放在内存中。这使得程序的大小被限制在物理内存的大小以内，然而在许多情况下，并不需要将整个程序放到内存中。能够执行只有部分在内存中的程序可以带来许多好处：   

- 程序不再受现有的物理内存空间限制。  
- 更多的程序可以同时执行，CPU的利用率也相应增加  。
- 由于载入或交换每个用户程序到内存所需的I/O更少，用户程序会运行得更快。   

虚拟内存（virtual memory）将用户逻辑内存与物理内存分开，为程序员提供了巨大的虚拟内存，这使得编程更加容易。使程序员不再需要担心可用的有限物理内存空间，只需要关注所要解决的问题。进程的虚拟地址空间就是进程如何在内存中存放的逻辑视图，如下图所示。除了将逻辑内存与物理内存分开，虚拟内存也允许文件和内存通过共享页尾两个或多个进程所共享。

![](https://raw.githubusercontent.com/liferlisiqi/liferlisiqi.github.io/master/img/2018-11-26-os6.jpg)

# 2 按需调页
一个执行程序从磁盘载入内存，一种选择是在程序执行时，将整个程序载入；另一种选择是在需要时才调入相应的页。这种技术称为`按需调页`(demand paging)，常为虚拟内存系统所采用。按需调页技术类似于使用交换的分页系统，不过不是将整个进程换入内存，而是在需要页时才将它调入内存。

当换入进程时，调页程序推测在该进程再次换出之前会用到哪些页，这种方案需要一定形式的硬件支持来区分哪些页在内存里，哪些页在磁盘上。当该位设置为“有效”时，该值表示相关的页既合法且也在内存中；当该位设置为“无效”时，该值表示相关的页为无效或者有效但是在磁盘上。当进程试图访问无效页时，会产生`缺页异常`，处理这种错误的程序比较简单，如下图所示。

![](https://raw.githubusercontent.com/liferlisiqi/liferlisiqi.github.io/master/img/2018-11-26-os7.jpg)


# 3 页面置换
页面置换采用如下办法：如果没有空闲帧，就查找当前没有使用的帧，并将其释放。释放一个帧的方法是：将其内容写到交换空间，并改变页表以表示该页不在内存中。修改缺页异常的处理程序如下：  
- 1 查找所需页咋磁盘上的位置
- 2 查找一个空闲帧：a 如果有空闲帧就使用该帧；b 如果没有空闲帧，就使用页面置换算法选择一个牺牲帧；c 将牺牲帧的内容写到磁盘上
- 3 将所需页读入空闲帧，改变页表和帧表
- 4 重启用户进程  

页面置换过程如下图所示。

![](https://raw.githubusercontent.com/liferlisiqi/liferlisiqi.github.io/master/img/2018-11-26-os8.jpg)

页面置换是按需调页的基础，它分开了逻辑内存和物理内存，对于按需调页，逻辑空间的大小不再受物理内存所限制。为了实现按需调页，必须解决两个主要问题：必须开发`帧分配算法`（frame-allocation algorithm）和`页面置换算法`（page-replacement algorithm）。如果在内存中有多个进程，那么必须决定为每个进程分配多少帧。当需要页面置换时，必须选择要置换的帧。

衡量页面置换算法的指标是缺页率：针对特定内存引用序列，运行某个置换算法，并计算出也错误的数量。为了知道页错误的数量，还需要知道可用帧的数量，因为随着可用帧数量的增加，页错误的数量一般会相应地减少。如下图所示。

![](https://raw.githubusercontent.com/liferlisiqi/liferlisiqi.github.io/master/img/2018-11-27-os9.jpg)

在说明各种页面置换算法之前，这里先介绍`Belady异常`（Belady's anomaly）。该现象是指：对有的页面置换算法，缺页率可能会随着所分配的帧数增加而增加，而原期望为增加内存会改善其性能。造成这种现象的原因在于：置换算法的特征与进程访问内存的特征相矛盾，被置换出的页面并不一定是进程近期不会访问的。
  
  
| 置换算法 | 思路 | 实现 | 特征 |
| :------: | :------: | :------: | :------: |
| 最优页面置换算法（OPT） | 置换在未来最长时间不访问的页面 | 稍微长一点的文本 | 稍微长一点的文本 |
| 先进先出算法（FIFO） | 短文本 | 中等文本 | 稍微长一点的文本 |
| 最近最久未使用算法（LRU） | 短文本 | 中等文本 | 稍微长一点的文本 |
| 时钟置换算法（Clock） | 短文本 | 中等文本 | 稍微长一点的文本 |
| 最不常用算法（LFU） | 短文本 | 中等文本 | 稍微长一点的文本 |



# 4 帧分配

# 5 全局页面置换

# 6 小结






## Reference
操作系统概念    
[操作系统-清华大学](http://os.cs.tsinghua.edu.cn/oscourse/OS2017spring)  
[Operation system: three easy piece](http://pages.cs.wisc.edu/~remzi/OSTEP/)  
